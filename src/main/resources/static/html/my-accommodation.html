<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Accommodation</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Page Title */
        h2 {
            color: #4CAF50;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        h3 {
            color: #333;
            margin-bottom: 10px;
            text-align: left;
        }

        /* Details Table Styling */
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .details-table th,
        .details-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
            word-wrap: break-word; /* Prevent overflow */
        }

        .details-table th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .details-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .details-table tr:hover {
            background-color: #f1f1f1;
        }

        .details-table td strong {
            color: #333;
        }

        .details-table td textarea {
            width: 100%; /* Ensure textarea fits within the cell */
            resize: none; /* Disable resizing */
            font-size: 0.9rem; /* Adjust font size */
            padding: 5px;
            box-sizing: border-box; /* Include padding and border in width calculation */
        }

        /* Buttons */
        .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .action-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .action-button:hover {
            background-color: #45a049;
        }

        /* Modal Styling */
        .modal {
            display: none; /* Initially hidden */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px; /* Adjust modal width */
            text-align: center;
            position: relative;
            overflow: hidden; /* Prevent overflow issues */
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover {
            color: #000;
        }

        .modal-content label {
            display: block;
            margin: 10px 0 5px;
            color: #333;
        }

        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .modal-content button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-content button:hover {
            background-color: #45a049;
        }

        /* Update button alignment */
        .update-complaint-button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            text-align: center;
            transition: background-color 0.3s;
        }

        .update-complaint-button:hover {
            background-color: #45a049;
        }

        /* Adjust modal title */
        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: #333;
            text-align: center;
        }
    </style>
</head>
<body>

<script>
    // Session validation to restrict unauthorized access
    const userId = sessionStorage.getItem("userId");
    if (!userId) {
        alert("You need to log in first.");
        window.location.href = "/html/login.html";
    }
</script>

<div class="navbar">
    <div class="dropdown">
        <button class="dropbtn" onclick="toggleDropdown()">Menu</button>
        <div class="dropdown-content">
            <a id="dashboardLink" href="#">Dashboard</a>
            <a id="logoutLink" href="#">Logout</a>
        </div>
    </div>
</div>

<div class="container">
    <h2>My Accommodation Details</h2>

    <!-- User Details -->
    <h3>User Information</h3>
    <table class="details-table" id="userDetailsTable">
        <thead>
        <tr>
            <th>Field</th>
            <th>Value</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <!-- Accommodation Details -->
    <h3>Accommodation Information</h3>
    <table class="details-table" id="accommodationDetailsTable">
        <thead>
        <tr>
            <th>Field</th>
            <th>Value</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button id="payRentButton" class="action-button">Pay Rent</button>
        <button id="fileComplaintButton" class="action-button">File Complaint</button>
        <button id="seeComplaintsButton" class="action-button">See Complaints</button>
    </div>

    <!-- Rent Payment Modal -->
    <div id="rentPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeRentModal()">&times;</span>
            <h3>Pay Rent</h3>
            <form id="rentPaymentForm">
                <label for="rentCardNumber">Card Number:</label>
                <input type="text" id="rentCardNumber" name="rentCardNumber" required pattern="\d{16}" placeholder="Enter 16-digit card number"><br>

                <label for="rentAmount">Amount:</label>
                <input type="text" id="rentAmount" name="rentAmount" readonly><br>
                <button type="submit">Confirm Payment</button>
            </form>
        </div>
    </div>

    <!-- Complaint Modal -->
    <div id="complaintModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeComplaintModal()">&times;</span>
            <h3>File Complaint</h3>
            <form id="complaintForm">
                <label for="complaintDescription">Description:</label>
                <textarea id="complaintDescription" name="complaintDescription" rows="5" placeholder="Enter your complaint details" required></textarea><br>
                <button type="submit">Submit Complaint</button>
            </form>
        </div>
    </div>

    <div id="seeComplaintsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeSeeComplaintsModal()">&times;</span>
            <h3>Pending Complaints</h3>
            <table class="details-table" id="complaintsTable">
                <thead>
                <tr>
                    <th>Complaint ID</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // Fetch and display user accommodation details
    fetch(`/accommodations/my-accommodation/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data) {
                const userDetailsTable = document.getElementById("userDetailsTable");
                userDetailsTable.innerHTML = `
                    <tr><td><strong>Name:</strong></td><td>${data.userName}</td></tr>
                    <tr><td><strong>Email:</strong></td><td>${data.email}</td></tr>
                `;

                const accommodationDetailsTable = document.getElementById("accommodationDetailsTable");
                accommodationDetailsTable.innerHTML = `
                    <tr><td><strong>Apartment Number:</strong></td><td>${data.apartmentNumber}</td></tr>
                    <tr><td><strong>Size:</strong></td><td>${data.accommodationSize}</td></tr>
                    <tr><td><strong>Lease Start Date:</strong></td><td>${data.leaseStartDate}</td></tr>
                    <tr><td><strong>Lease End Date:</strong></td><td>${data.leaseEndDate}</td></tr>
                    <tr><td><strong>Rent Due Date:</strong></td><td>${data.dueDate}</td></tr>
                    <tr><td><strong>Current Rent:</strong></td><td>$${data.currentRent.toFixed(2)}</td></tr>
                `;
            } else {
                alert("No accommodation details found.");
            }
        })
        .catch(error => console.error("Error fetching accommodation details:", error));

    // Open the rent payment modal
    document.getElementById("payRentButton").addEventListener("click", function () {
        fetch(`/accommodations/my-accommodation/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    document.getElementById("rentAmount").value = data.currentRent.toFixed(2);
                    document.getElementById("rentPaymentModal").style.display = "flex";
                } else {
                    alert("No accommodation details found.");
                }
            })
            .catch(error => console.error("Error fetching accommodation details:", error));
    });


    // Open the complaint modal
    document.getElementById("fileComplaintButton").addEventListener("click", function () {
        document.getElementById("complaintModal").style.display = "flex";
    });

    // See Complaints Modal
    // Open See Complaints Modal
    document.getElementById("seeComplaintsButton").addEventListener("click", function () {
        fetch(`/accommodations/user-complaints/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const complaintsTable = document.getElementById("complaintsTable").getElementsByTagName("tbody")[0];
                    complaintsTable.innerHTML = ""; // Clear table
                    data.forEach((complaint, index) => { // Add index for serial numbers
                        const row = complaintsTable.insertRow();
                        row.innerHTML = `
                        <td>${index + 1}</td> <!-- Serial number starts from 1 -->
                        <td>
                            <textarea class="complaint-description" data-complaint-id="${complaint.id}">${complaint.description}</textarea>
                        </td>
                        <td>${complaint.status}</td>
                        <td>
                            <button class="update-complaint-button" data-complaint-id="${complaint.id}">Update</button>
                        </td>
                    `;
                    });

                    // Add event listeners for each update button
                    document.querySelectorAll(".update-complaint-button").forEach(button => {
                        button.addEventListener("click", function () {
                            const complaintId = this.getAttribute("data-complaint-id");
                            const description = document.querySelector(`textarea[data-complaint-id="${complaintId}"]`).value;
                            updateComplaint(complaintId, description);
                        });
                    });

                    document.getElementById("seeComplaintsModal").style.display = "flex";
                } else {
                    alert("No complaints found.");
                }
            })
            .catch(error => {
                console.error("Error fetching complaints:", error);
                alert("Error fetching complaints.");
            });
    });

    // Update Complaint
    function updateComplaint(complaintId, description) {
        fetch(`/accommodations/update-complaint`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ complaintId, description }),
        })
            .then(response => {
                if (response.ok) {
                    alert("Complaint updated successfully!");
                    window.location.reload();
                } else {
                    alert("Failed to update complaint. Please try again.");
                }
            })
            .catch(error => console.error("Error updating complaint:", error));
    }

    // Close See Complaints Modal
    function closeSeeComplaintsModal() {
        document.getElementById("seeComplaintsModal").style.display = "none";
    }

    // Close rent payment modal
    function closeRentModal() {
        document.getElementById("rentPaymentModal").style.display = "none";
    }

    // Close complaint modal
    function closeComplaintModal() {
        document.getElementById("complaintModal").style.display = "none";
    }

    // Handle rent payment form submission
    document.getElementById("rentPaymentForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const cardNumber = document.getElementById("rentCardNumber").value;
        const rentAmount = document.getElementById("rentAmount").value;

        fetch(`/accommodations/pay-rent`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                userId,
                rentAmount,
                cardNumber
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("Rent payment successful!");
                    closeRentModal();
                    window.location.reload();
                } else {
                    alert("Rent payment failed. Please try again.");
                }
            })
            .catch(error => console.error("Error processing rent payment:", error));
    });

    // Handle complaint form submission
    document.getElementById("complaintForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const description = document.getElementById("complaintDescription").value;

        fetch(`/accommodations/file-complaint`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                userId,
                description
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("Complaint filed successfully!");
                    closeComplaintModal();
                    window.location.reload();
                } else {
                    alert("Failed to file complaint. Please try again.");
                }
            })
            .catch(error => console.error("Error filing complaint:", error));
    });

    // Redirect to Dashboard
    document.getElementById("dashboardLink").addEventListener("click", function (event) {
        event.preventDefault();
        window.location.href = "/html/index.html";
    });

    // Logout functionality
    document.getElementById("logoutLink").addEventListener("click", function (event) {
        event.preventDefault();
        fetch("/users/logout", { method: "POST" })
            .then(() => {
                sessionStorage.removeItem("userId");
                window.location.href = "/html/login.html";
            });
    });

    // Toggle dropdown menu functionality
    function toggleDropdown() {
        const dropdown = document.querySelector(".dropdown");
        dropdown.classList.toggle("active");
    }

    // Close dropdown if clicked outside
    window.addEventListener("click", function (e) {
        const dropdown = document.querySelector(".dropdown");
        if (!dropdown.contains(e.target)) {
            dropdown.classList.remove("active");
        }
    });
</script>

</body>
</html>