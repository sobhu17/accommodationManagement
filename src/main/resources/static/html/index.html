<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<script>
    // Session validation to restrict unauthorized access
    const userId = sessionStorage.getItem("userId");
    if (!userId) {
        alert("You need to log in first.");
        window.location.href = "/html/login.html";
    }
</script>

<div class="navbar">
    <div class="dropdown">
        <button class="dropbtn" onclick="toggleDropdown()">Menu</button>
        <div class="dropdown-content">
            <a id="myAccommodationLink" href="#">My Accommodation</a>
            <a id="logoutLink" href="#">Logout</a>
        </div>
    </div>
</div>

<div class="container">
    <h2>Welcome to the Dashboard</h2>
    <p>This is your private dashboard.</p>

    <h3>Available Accommodations</h3>
    <div id="accommodationsList"></div>

    <!-- Initial Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3>Proceed to Payment</h3>
            <p>Your lease payment for this accommodation is required.</p>
            <button id="payButton">Pay Now</button>
        </div>
    </div>

    <!-- Card Payment Modal -->
    <div id="cardPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCardModal()">&times;</span>
            <h3>Enter Payment Details</h3>
            <form id="cardPaymentForm">
                <label for="cardNumber">Card Number:</label>
                <input type="text" id="cardNumber" name="cardNumber" required pattern="\d{16}" placeholder="Enter 16-digit card number"><br>

                <label for="amount">Amount:</label>
                <input type="text" id="amount" name="amount" value="1000" readonly><br>

                <button type="submit">Confirm Payment</button>
            </form>
        </div>
    </div>
</div>

<script>
    let selectedAccommodationId = null;

    // Redirect to My Accommodation page
    document.getElementById("myAccommodationLink").addEventListener("click", function (event) {
        event.preventDefault(); // Prevent default link behavior
        if (userId) {
            fetch(`/accommodations/my-accommodation/${userId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("No accommodation found.");
                    }
                })
                .then(data => {
                    if (data && data.userName) {
                        // Redirect to My Accommodation page if accommodation exists
                        window.location.href = `/html/my-accommodation.html?userId=${userId}`;
                    } else {
                        alert("You don't have an accommodation yet. Please book an accommodation first!");
                    }
                })
                .catch(() => {
                    alert("You don't have an accommodation yet. Please book an accommodation first!");
                });
        } else {
            alert("You need to log in first.");
            window.location.href = "/login.html";
        }
    });

    // Fetch accommodations only if the user has not already booked one
    fetch(`/accommodations/my-active-booking/${userId}`)
        .then(response => {
            if (response.status === 404) {
                // No active booking, fetch available accommodations
                return fetch("/accommodations/available")
                    .then(response => response.json())
                    .then(data => {
                        const accommodationsList = document.getElementById("accommodationsList");
                        accommodationsList.innerHTML = "";

                        data.forEach(accommodation => {
                            const accommodationDiv = document.createElement("div");
                            accommodationDiv.classList.add("accommodation");

                            const imageUrl = "/images/default.jpg";

                            accommodationDiv.innerHTML = `
                                <img src="${imageUrl}" alt="Accommodation Image" class="apartment-image">
                                <div class="accommodation-details">
                                    <h4>Apartment ${accommodation.apartment_number} - ${accommodation.size}</h4>
                                    <p>Description: ${accommodation.description}</p>
                                </div>
                                <div class="book-button-container">
                                    <button class="book-button" onclick="openModal(${accommodation.accommodation_id})">Book</button>
                                </div>
                            `;

                            accommodationsList.appendChild(accommodationDiv);
                        });
                    });
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.bookingId) {
                const accommodationsList = document.getElementById("accommodationsList");
                accommodationsList.innerHTML = `
                    <p>You already have an active booking. Please visit the <a href="/html/my-accommodation.html">My Accommodation</a> page to view your details.</p>
                `;
            }
        })
        .catch(error => {
            console.error("Error fetching accommodations:", error);
        });

    // Open the initial payment modal
    function openModal(accommodationId) {
        selectedAccommodationId = accommodationId;
        document.getElementById("paymentModal").style.display = "flex";
    }

    // Close the initial payment modal
    function closeModal() {
        document.getElementById("paymentModal").style.display = "none";
    }

    // Open the card payment modal
    function openCardModal() {
        closeModal(); // Close the first modal
        document.getElementById("cardPaymentModal").style.display = "flex";
    }

    // Close the card payment modal
    function closeCardModal() {
        document.getElementById("cardPaymentModal").style.display = "none";
    }

    // Toggle dropdown menu functionality
    function toggleDropdown() {
        const dropdown = document.querySelector(".dropdown");
        dropdown.classList.toggle("active");
    }

    // Close the dropdown if clicked outside
    window.addEventListener("click", function (e) {
        const dropdown = document.querySelector(".dropdown");
        if (!dropdown.contains(e.target)) {
            dropdown.classList.remove("active");
        }
    });

    // Handle the Pay Now button in the initial payment modal
    document.getElementById("payButton").addEventListener("click", function() {
        openCardModal();
    });

    // Handle the card payment form submission
    document.getElementById("cardPaymentForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const cardNumber = document.getElementById("cardNumber").value;

        fetch(`/accommodations/book`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                accommodationId: selectedAccommodationId,
                userId: sessionStorage.getItem("userId"),
                cardNumber: cardNumber,
                amount: 1000,  // Fixed amount for lease payment
            })
        })
            .then(response => {
                if (response.ok) {
                    closeCardModal();
                    window.location.reload(); // Refresh the page to update the list
                } else {
                    closeCardModal();
                    console.error("Payment failed. Please try again.");
                }
            });
    });

    // Logout functionality (for dropdown logout button)
    document.getElementById("logoutLink").addEventListener("click", function (event) {
        event.preventDefault();
        fetch("/users/logout", { method: "POST" })
            .then(() => {
                sessionStorage.removeItem("userId");
                window.location.href = "/html/login.html";
            });
    });
</script>
</body>
</html>
